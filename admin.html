<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin • 1CoastMedia</title>

<link rel="icon" href="/assets/1coastmedia_logo_A_primary_mark_2048.jpg"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Tailwind (admin-only) -->
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={theme:{extend:{}}}</script>

<!-- Alpine -->
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Sortable for drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<style>
  body{font-family:Inter,ui-sans-serif,system-ui}
  .card{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:1rem;box-shadow:0 10px 28px rgba(2,6,23,.06)}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:1rem;background:rgba(2,6,23,.5);z-index:50}
  .modal>div{max-width:780px;width:100%}
  .input{width:100%;border:1px solid rgba(15,23,42,.12);border-radius:.6rem;padding:.65rem .8rem}
  .label{font-size:.75rem;color:#64748b}

  /* Reorder UX */
  .drag-handle { cursor: grab; touch-action: pan-y; user-select: none; }
  .drag-handle:active { cursor: grabbing; }
  .drag-ghost { opacity:.65; transform:scale(.995); }
  .drag-dragging { opacity:.9; }
</style>
</head>

<body class="bg-slate-50" x-data="adminApp()" x-init="init()">

  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
      <a class="flex items-center gap-3" href="/" target="_blank" rel="noreferrer">
        <img src="/assets/1coastmedia_logo_A_primary_mark_2048.jpg" alt="1CoastMedia" class="h-8 w-8 rounded"/>
        <div class="font-extrabold tracking-tight">1CoastMedia — Admin</div>
      </a>
      <div class="text-sm text-slate-600">
        <template x-if="authed">
          <span>Signed in as <b x-text="me||'admin'"></b></span>
        </template>
        <button x-show="authed" @click="logout"
                class="ml-3 px-3 py-1.5 rounded bg-slate-900 text-white text-sm">Logout</button>
      </div>
    </div>
  </header>

  <!-- Login -->
  <section class="max-w-md mx-auto p-6" x-show="!authed" x-transition>
    <div class="card p-6">
      <h1 class="text-xl font-bold">Admin login</h1>
      <p class="text-sm text-slate-500 mt-1">Use the credentials from your Vercel env vars.</p>
      <div class="mt-4 space-y-3">
        <div>
          <label class="label">Username</label>
          <input x-model="login.username" class="input" autocomplete="username"/>
        </div>
        <div>
          <label class="label">Password</label>
          <input x-model="login.password" type="password" class="input" autocomplete="current-password" @keydown.enter="doLogin"/>
        </div>
        <button @click="doLogin" class="w-full mt-2 rounded bg-indigo-600 text-white font-semibold px-4 py-2">Sign in</button>
      </div>
      <p class="text-xs text-rose-600 mt-3" x-text="error"></p>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-6" x-show="authed" x-transition>
    <!-- Tabs -->
    <nav class="flex gap-1 text-sm">
      <template x-for="t in tabs" :key="t.id">
        <button class="px-3 py-1.5 rounded-lg"
                :class="tab===t.id ? 'bg-slate-900 text-white' : 'bg-white ring-1 ring-slate-200 text-slate-700'"
                @click="tab=t.id; $nextTick(()=>{ if(t.id==='catalog') mountReorder(); })"
                x-text="t.label"></button>
      </template>
      <div class="ml-auto flex items-center gap-2">
        <button class="px-3 py-1.5 rounded bg-emerald-600 text-white text-sm" @click="syncFromSite" :disabled="busy">
          <span x-show="!busy">Sync from site</span>
          <span x-show="busy" class="inline-flex items-center gap-2">
            <span class="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>Working…
          </span>
        </button>
        <button class="px-3 py-1.5 rounded bg-slate-900 text-white text-sm" @click="refreshAll">Refresh</button>
      </div>
    </nav>

    <!-- OVERVIEW -->
    <section x-show="tab==='overview'" x-transition>
      <!-- KPIs -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card p-4">
          <div class="text-xs text-slate-500">Revenue</div>
          <div class="text-2xl font-extrabold" x-text="fmtUSD(kpis.revenue_cents)"></div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-slate-500">Paid Orders</div>
          <div class="text-2xl font-extrabold" x-text="kpis.orders"></div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-slate-500">Customers</div>
          <div class="text-2xl font-extrabold" x-text="kpis.customers"></div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-slate-500">Pageviews</div>
          <div class="text-2xl font-extrabold" x-text="kpis.pageviews"></div>
        </div>
      </div>

      <!-- Orders quick view -->
      <div class="mt-6 card overflow-auto">
        <div class="p-3 flex items-center justify-between gap-3">
          <h3 class="text-lg font-semibold">Recent Orders</h3>
          <div class="flex items-center gap-2">
            <input class="input !py-1.5 !text-sm" placeholder="Search email/plan…" x-model.trim="ordersQuery">
            <button class="px-3 py-1.5 rounded ring-1 ring-slate-200 text-sm" @click="downloadCSV(filteredOrders,'orders.csv')">Export CSV</button>
          </div>
        </div>
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-600">
            <tr>
              <th class="text-left p-2">Date</th>
              <th class="text-left p-2">Customer</th>
              <th class="text-left p-2">Plan</th>
              <th class="text-left p-2">Status</th>
              <th class="text-left p-2">Total</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="o in filteredOrders" :key="o.id">
              <tr class="border-t">
                <td class="p-2" x-text="new Date(o.created_at).toLocaleString()"></td>
                <td class="p-2" x-text="o.contact_email || '—'"></td>
                <td class="p-2" x-text="o.plan"></td>
                <td class="p-2" x-text="o.status"></td>
                <td class="p-2" x-text="fmtUSD(o.total_cents)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CATALOG (Services, Add-ons, Reorder) -->
    <section x-show="tab==='catalog'" x-transition class="space-y-6">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Services -->
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold">Base Services</h2>
            <div class="flex items-center gap-2">
              <input class="input !py-1.5 !text-sm" placeholder="Search services…" x-model.trim="svcQuery">
              <button class="px-3 py-1.5 text-sm rounded bg-slate-900 text-white" @click="openService()">+ New</button>
            </div>
          </div>
          <div class="space-y-3 max-h-[60vh] overflow-auto pr-1">
            <template x-for="s in filteredServices" :key="s.id">
              <div class="border rounded p-3">
                <div class="flex items-center justify-between">
                  <div class="font-semibold" x-text="s.name"></div>
                  <div class="text-xs text-slate-500" x-text="s.id"></div>
                </div>
                <div class="text-xs text-slate-500 mt-0.5" x-text="s.blurb || ''"></div>
                <div class="text-xs mt-1">
                  One-time: <b x-text="fmtUSD(s.base_one_time_cents)"></b> •
                  Monthly: <b x-text="fmtUSD(s.base_monthly_cents)"></b>
                </div>
                <div class="text-xs mt-1">Includes: <span x-text="(s.includes||[]).join(', ') || '—'"></span></div>
                <div class="mt-2 flex gap-2">
                  <button class="px-2 py-1 text-xs rounded bg-indigo-600 text-white" @click="openService(s)">Edit</button>
                  <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white" @click="delService(s.id)">Delete</button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Add-ons -->
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold">Add-ons</h2>
            <div class="flex items-center gap-2">
              <select class="input !py-1.5 !text-sm" x-model="addonSvcFilter">
                <option value="">All services</option>
                <template x-for="s in services" :key="'opt-'+s.id">
                  <option :value="s.id" x-text="s.id"></option>
                </template>
              </select>
              <input class="input !py-1.5 !text-sm" placeholder="Search add-ons…" x-model.trim="addonQuery">
              <button class="px-3 py-1.5 text-sm rounded bg-slate-900 text-white" @click="openAddon()">+ New</button>
            </div>
          </div>
          <div class="space-y-3 max-h-[60vh] overflow-auto pr-1">
            <template x-for="a in filteredAddons" :key="a.id">
              <div class="border rounded p-3">
                <div class="flex items-center justify-between">
                  <div class="font-semibold" x-text="a.label"></div>
                  <div class="text-xs text-slate-500" x-text="a.id"></div>
                </div>
                <div class="text-xs text-slate-500 mt-0.5" x-text="a.description || ''"></div>
                <div class="text-xs mt-1">
                  Service: <b x-text="a.service_id"></b> •
                  One-time: <b x-text="fmtUSD(a.price_one_time_cents)"></b> •
                  Monthly: <b x-text="fmtUSD(a.price_monthly_cents)"></b>
                </div>
                <div class="mt-2 flex gap-2">
                  <button class="px-2 py-1 text-xs rounded bg-indigo-600 text-white" @click="openAddon(a)">Edit</button>
                  <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white" @click="delAddon(a.id)">Delete</button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Reorder services -->
      <section>
        <div class="flex items-center justify-between mb-2">
          <div>
            <h3 class="text-lg font-semibold">Reorder Base Services (drag & drop)</h3>
            <p class="text-xs text-slate-500">This controls the tile order on the homepage.</p>
          </div>
          <div class="flex gap-2">
            <button id="refreshOrderBtn"
                    class="rounded-lg ring-1 ring-slate-200 bg-white px-3 py-2 text-sm"
                    @click="loadCatalog()">Reload</button>
            <button id="saveOrderBtn"
                    class="rounded-lg bg-indigo-600 text-white px-4 py-2 font-semibold disabled:opacity-50"
                    :disabled="!dirtyOrder"
                    @click="saveCatalog()"
                    x-text="dirtyOrder ? 'Save Order' : 'Saved'"></button>
          </div>
        </div>

        <!-- Scrollable container for long lists -->
        <div id="orderScroll" class="max-h-[70vh] overflow-y-auto overscroll-contain pr-1">
          <ul id="orderList" class="grid gap-2"></ul>
        </div>
      </section>
    </section>

    <!-- CUSTOMERS -->
    <section x-show="tab==='customers'" x-transition>
      <div class="card overflow-auto">
        <div class="p-3 flex items-center justify-between gap-3">
          <h3 class="text-lg font-semibold">Customers</h3>
          <div class="flex items-center gap-2">
            <input class="input !py-1.5 !text-sm" placeholder="Search email/name…" x-model.trim="custQuery">
            <button class="px-3 py-1.5 rounded ring-1 ring-slate-200 text-sm" @click="downloadCSV(filteredCustomers,'customers.csv')">Export CSV</button>
          </div>
        </div>
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-600">
            <tr>
              <th class="text-left p-2">Created</th>
              <th class="text-left p-2">Email</th>
              <th class="text-left p-2">Name</th>
              <th class="text-left p-2">Company</th>
              <th class="text-left p-2">Phone</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="c in filteredCustomers" :key="c.id">
              <tr class="border-t">
                <td class="p-2" x-text="new Date(c.created_at).toLocaleString()"></td>
                <td class="p-2" x-text="c.email || '—'"></td>
                <td class="p-2" x-text="c.name || '—'"></td>
                <td class="p-2" x-text="c.company || '—'"></td>
                <td class="p-2" x-text="c.phone || '—'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>

    <!-- LEADS -->
    <section x-show="tab==='leads'" x-transition>
      <div class="card overflow-auto">
        <div class="p-3 flex items-center justify-between gap-3">
          <h3 class="text-lg font-semibold">Leads (Contact form)</h3>
          <div class="flex items-center gap-2">
            <input class="input !py-1.5 !text-sm" placeholder="Search email/name…" x-model.trim="leadQuery">
            <button class="px-3 py-1.5 rounded ring-1 ring-slate-200 text-sm" @click="downloadCSV(filteredLeads,'leads.csv')">Export CSV</button>
          </div>
        </div>
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-600">
            <tr>
              <th class="text-left p-2">Created</th>
              <th class="text-left p-2">Email</th>
              <th class="text-left p-2">Name</th>
              <th class="text-left p-2">Company</th>
              <th class="text-left p-2">Phone</th>
              <th class="text-left p-2">Notes</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="l in filteredLeads" :key="l.id">
              <tr class="border-t align-top">
                <td class="p-2" x-text="new Date(l.created_at).toLocaleString()"></td>
                <td class="p-2" x-text="l.email || '—'"></td>
                <td class="p-2" x-text="l.name || '—'"></td>
                <td class="p-2" x-text="l.company || '—'"></td>
                <td class="p-2" x-text="l.phone || '—'"></td>
                <td class="p-2 max-w-[28rem] whitespace-pre-wrap" x-text="l.notes || '—'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- SERVICE MODAL -->
  <div class="modal" x-show="modals.service" x-transition @keydown.escape.window="modals.service=false">
    <div class="card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold" x-text="serviceForm._lockId ? 'Edit Service' : 'New Service'"></h3>
        <button class="h-9 w-9 rounded hover:bg-slate-100 grid place-items-center" @click="modals.service=false">✕</button>
      </div>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <div>
          <label class="label">Key (e.g. web)</label>
          <input class="input" x-model.trim="serviceForm.id" :disabled="!!serviceForm._lockId"/>
        </div>
        <div>
          <label class="label">Name</label>
          <input class="input" x-model.trim="serviceForm.name"/>
        </div>
        <div class="md:col-span-2">
          <label class="label">Blurb</label>
          <input class="input" x-model.trim="serviceForm.blurb"/>
        </div>
        <div>
          <label class="label">Base (One-time) USD</label>
          <input type="number" class="input" x-model.number="serviceForm.base_one_time_usd"/>
        </div>
        <div>
          <label class="label">Base (Monthly) USD</label>
          <input type="number" class="input" x-model.number="serviceForm.base_monthly_usd"/>
        </div>
        <div class="md:col-span-2">
          <label class="label">Includes (comma separated)</label>
          <input class="input" x-model.trim="serviceForm.includes_csv" placeholder="Kickoff & setup, Landing page (3–5 sections), Light copy help"/>
        </div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button class="px-3 py-2 rounded border" @click="modals.service=false">Cancel</button>
        <button class="px-3 py-2 rounded bg-indigo-600 text-white" @click="saveService">Save</button>
      </div>
      <p class="text-xs text-rose-600 mt-2" x-text="formError"></p>
    </div>
  </div>

  <!-- ADDON MODAL -->
  <div class="modal" x-show="modals.addon" x-transition @keydown.escape.window="modals.addon=false">
    <div class="card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold" x-text="addonForm._lockId ? 'Edit Add-on' : 'New Add-on'"></h3>
        <button class="h-9 w-9 rounded hover:bg-slate-100 grid place-items-center" @click="modals.addon=false">✕</button>
      </div>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <div>
          <label class="label">ID (e.g. web-seo)</label>
          <input class="input" x-model.trim="addonForm.id" :disabled="!!addonForm._lockId"/>
        </div>
        <div>
          <label class="label">Service</label>
          <select class="input" x-model="addonForm.service_id">
            <template x-for="s in services" :key="'sopt-'+s.id">
              <option :value="s.id" x-text="s.id"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="label">Label</label>
          <input class="input" x-model.trim="addonForm.label"/>
        </div>
        <div>
          <label class="label">Badge</label>
          <input class="input" x-model.trim="addonForm.badge"/>
        </div>
        <div class="md:col-span-2">
          <label class="label">Short</label>
          <input class="input" x-model.trim="addonForm.short"/>
        </div>
        <div class="md:col-span-2">
          <label class="label">Description</label>
          <textarea class="input" x-model.trim="addonForm.description"></textarea>
        </div>
        <div>
          <label class="label">One-time USD</label>
          <input type="number" class="input" x-model.number="addonForm.price_one_time_usd"/>
        </div>
        <div>
          <label class="label">Monthly USD</label>
          <input type="number" class="input" x-model.number="addonForm.price_monthly_usd"/>
        </div>
        <div class="flex items-center gap-2">
          <input id="popular" type="checkbox" x-model="addonForm.popular"/>
          <label for="popular" class="text-sm">Popular</label>
        </div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button class="px-3 py-2 rounded border" @click="modals.addon=false">Cancel</button>
        <button class="px-3 py-2 rounded bg-indigo-600 text-white" @click="saveAddon">Save</button>
      </div>
      <p class="text-xs text-rose-600 mt-2" x-text="formError"></p>
    </div>
  </div>

  <!-- Toast -->
  <div x-show="toast.show" x-transition
       class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white rounded px-4 py-2 shadow">
    <span x-text="toast.text"></span>
  </div>

<script>
const API = (r) => `/api/admin?r=${encodeURIComponent(r)}`;

function adminApp(){
  return {
    // ---- state ----
    authed:false, me:null, error:'', formError:'', busy:false,
    tab:'overview',
    tabs:[{id:'overview',label:'Overview'},{id:'catalog',label:'Catalog'},{id:'customers',label:'Customers'},{id:'leads',label:'Leads'}],
    login:{username:'',password:''},

    kpis:{revenue_cents:0,orders:0,customers:0,pageviews:0},
    orders:[], customers:[], leads:[], services:[], addons:[],

    // filters
    ordersQuery:'', custQuery:'', leadQuery:'', svcQuery:'', addonQuery:'', addonSvcFilter:'',

    // modals/forms
    modals:{service:false, addon:false}, toast:{show:false,text:''},
    serviceForm:{id:'', _lockId:false, name:'', blurb:'', base_one_time_usd:0, base_monthly_usd:0, includes_csv:''},
    addonForm:{id:'', _lockId:false, service_id:'', label:'', description:'', short:'', badge:'', popular:false, price_one_time_usd:0, price_monthly_usd:0},

    // reorder
    orderServices:[], dirtyOrder:false, _sortableInited:false,

    // one-click seed (unchanged from your version)
    siteCatalog:{ services:[{key:'web',name:'Web & App',blurb:'Launch a clean, mobile-first site fast.',base:{oneTime:300,monthly:500},includes:['Kickoff & setup','Landing page (3–5 sections)','Light copy help']},{key:'video',name:'Video / Audio',blurb:'Short, on-brand edits that convert.',base:{oneTime:600,monthly:1200},includes:['Kickoff & plan','1–2 min edit','Clean edit, coastal vibe']},{key:'events',name:'Events',blurb:'Plan smooth, run tight, look great.',base:{oneTime:1000,monthly:1200},includes:['Scope & timeline','Basic coordination','Day-of support']},{key:'ugc',name:'UGC',blurb:'Creators + clips that actually get seen.',base:{oneTime:450,monthly:600},includes:['Kickoff & setup','30k verified views','Simple report']}],
      addons:[['web','web-seo','SEO Basics','Titles, speed checks, findable.','Quick search wins','Quick win',true,150,150],['web','web-auto','Lead Automations','Instant replies to leads.','Never miss a lead','Hands-off',true,100,100],['web','web-api','Payments & Maps','Stripe checkout + maps.','High-impact add','High impact',false,250,250],['web','web-mvp','Clickable MVP','Tap-through prototype.','Test ideas','Prototype',false,500,500],['web','web-copy','Website Copywriting','We write clear, on-brand copy.','Words that sell','Done-for-you',false,120,120],['web','web-speed','Speed & Security','Performance boosts + hardening.','Faster & safer','Speed',false,150,150],['web','web-forms','Smart Forms','Lead routing + spam block.','Higher conversions','Leads',false,150,100],['web','web-analytics','Analytics Setup','Simple dashboard + goals.','Know what works','Insight',false,100,120],['web','web-blog','Blog/CMS Setup','Easy updates, categories, tags.','Publish fast','Content',false,200,150],['web','web-booking','Booking Integration','Calendly/Square appointments.','Fewer no-shows','Conversion',false,150,120],['web','web-reviews','Reviews Widget','Pull Google/FB reviews on site.','Build trust','Trust',false,100,100],['web','web-a11y','Accessibility Audit','WCAG quick audit + fixes.','Compliance wins','Compliance',false,180,150],['web','web-i18n','Multi-language','Key pages in 2nd language.','Expand reach','Reach',false,220,150],['web','web-dns','Domain & DNS','Purchase, connect, SSL.','We handle setup','Setup',false,80,0],['web','web-section','Custom Section','1 bespoke section block.','Tailored UI','Custom',false,120,120],['web','web-photos','Photo Sourcing','Handpicked stock + edits.','Better visuals','Visuals',false,90,90],['web','web-brandkit','Brand Kit','Fonts, colors, components.','Consistent look','Brand',false,200,150],['video','vid-audio','Clean Audio + Captions','Noise fix + captions.','Watchable anywhere','Accessibility',true,200,250],['video','vid-adv','Advanced Edit / Series','More story, motion, polish.','Flagship content','Premium',true,800,1000],['video','vid-drone-p','Drone B-roll (Basic)','Dynamic aerial flavor.','Wow factor','Wow',false,300,300],['video','vid-drone-pro','Drone Cinematics (Pro)','Licensed pilot + pro gear.','Top-tier aerials','Cinematic',false,1500,1500],['video','vid-extra','Extra Edit Pass','More refinements + cuts.','Sharper pacing','Polish',false,300,500],['video','vid-script','Script & Shotlist','Plan lines + shots.','Shoot with ease','Plan',false,150,150],['video','vid-color','Pro Color Grade','Crisp, cinematic look.','Standout look','Look',false,150,150],['video','vid-sizes','All Social Sizes','9:16, 1:1, 16:9 outputs.','Every platform','Everywhere',false,120,120],['video','vid-thumbs','Thumbnail Pack (x3)','Scroll-stopping covers.','Higher CTR','Hook',false,100,100],['video','vid-raw','Raw Footage Delivery','We hand you the files.','Own the source','Archive',false,60,60],['video','vid-voice','Voiceover','Pro VO talent included.','Narration','Pro',false,220,220],['video','vid-tele','Teleprompter','Confident on-camera lines.','Confidence','Assist',false,90,90],['video','vid-studio','Studio Day','Lighting, backdrops, sound.','Controlled set','Studio',false,700,700],['video','vid-multi','Multi-location Shoot','Up to 3 locations.','More variety','Scope',false,400,400],['video','vid-cast','Talent Casting','Find on-brand talent.','Right faces','Talent',false,300,300],['events','ev-ven','Vendor/Venue Handling','We wrangle calls.','Stress-free','Stress-free',true,500,600],['events','ev-digital','RSVP/Tickets Page','Modern guest flow.','Smooth RSVPs','Modern',false,200,200],['events','ev-media','Highlight Media','Recap video + photos.','Shareworthy','Content',false,300,300],['events','ev-auto','Guest Automations','Reminders + check-in.','No bottlenecks','Smooth',false,150,150],['events','ev-hybrid','Livestream Setup','Hybrid reach, simple.','Reach more','Reach',false,400,400],['events','ev-host','Host / MC','Energy + timing control.','Keep pace','Energy',false,250,250],['events','ev-runshow','Run-of-Show','Minute-by-minute plan.','Clarity','Clarity',false,150,150],['events','ev-sponsor','Sponsor Kit + Outreach','Deck + outreach.','New revenue','Revenue',false,200,200],['events','ev-security','Permits & Security Guide','Who to call + when.','Safer event','Safety',false,120,120],['events','ev-vip','VIP/Backstage Mgmt','Green room + access.','White-glove','VIP',false,200,200],['events','ev-photobooth','Photo Booth','Branded photos on site.','Fun moments','Fun',false,350,350],['events','ev-ticketing','Ticketing Integration','Stripe/Square, QR.','Faster gates','Revenue',false,220,220],['ugc','ugc-repurpose','Ads-Ready Pack','Cut-downs + hooks.','Convert more','Ads-ready',true,200,200],['ugc','ugc-leads','Lead Capture Page','Turn views to contacts.','Capture demand','Leads',false,250,250],['ugc','ugc-enhance','Eye-Candy Overlays','On-brand text, beats.','More watch time','Engaging',false,150,150],['ugc','ugc-captions','SEO Captions','Be found & tapped.','Search hits','Search',false,100,100],['ugc','ugc-brand','Branding Pack','Logos, end-slates.','Brand recall','Brand',false,150,150],['ugc','ugc-views-10k','+10k Views','~10,000 verified views.','+10k reach','+10k',false,150,150],['ugc','ugc-views-20k','+20k Views','~20,000 verified views.','+20k reach','+20k',false,300,300],['ugc','ugc-views-70k','+70k Views','~70,000 verified views.','+70k reach','+70k',false,1050,1050],['ugc','ugc-creator','Creator Matching','Shortlist best locals.','Best fit','Match',false,100,100],['ugc','ugc-studio','Studio Polish','Re-cut with pro touch.','Pro finish','Pro',false,150,150],['ugc','ugc-comment','Comment Reply Pack','Smart replies to boost.','Engage more','Engage',false,100,100],['ugc','ugc-tracking','Tracking Upgrade','Deeper insights.','Better decisions','Insight',false,120,120],['ugc','ugc-white','Whitelisting Rights','Run creator posts as ads.','Run as ads','Rights',false,220,220],['ugc','ugc-usage','Usage Rights Extension','Extend paid usage.','More time','Rights',false,180,180],['ugc','ugc-hooks','A/B Hooks Pack','5 alt hooks to test.','Test faster','Test',false,140,140]]},

    // ---------- lifecycle ----------
    async init(){ await this.checkAuth(); if(this.authed){ await this.refreshAll(); } },

    // ---------- auth ----------
    async checkAuth(){ try{ const r=await fetch(API('me')); if(!r.ok) throw 0; const j=await r.json(); this.me=j.user; this.authed=true; }catch{ this.authed=false; } },
    async doLogin(){
      this.error='';
      const r=await fetch(API('login'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(this.login)});
      if(!r.ok){ this.error='Invalid login'; return; }
      this.authed=true; this.me=this.login.username; this.login={username:'',password:''}; await this.refreshAll();
    },
    async logout(){ await fetch(API('logout')); location.reload(); },

    // ---------- data loaders ----------
    async refreshAll(){
      const [m,o,c,l,s,a]=await Promise.all([
        fetch(API('metrics')).then(r=>r.json()).catch(()=>({revenue_cents:0,orders:0,customers:0,pageviews:0})),
        fetch(API('orders')).then(r=>r.json()).catch(()=>[]),
        fetch(API('customers')).then(r=>r.json()).catch(()=>[]),
        fetch(API('leads')).then(r=>r.json()).catch(()=>[]),
        fetch(API('services')).then(r=>r.json()).catch(()=>[]),
        fetch(API('addons')).then(r=>r.json()).catch(()=>[]),
      ]);
      this.kpis=m; this.orders=o; this.customers=c; this.leads=l; this.services=s; this.addons=a;
      if (this.tab==='catalog') { await this.loadCatalog(); }
    },

    // ---------- filters / computed ----------
    fmtUSD(c){ return (Number(c||0)/100).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}); },
    get filteredOrders(){
      const q=this.ordersQuery.toLowerCase().trim(); if(!q) return this.orders.slice(0,50);
      return this.orders.filter(o => (o.contact_email||'').toLowerCase().includes(q) || (o.plan||'').toLowerCase().includes(q));
    },
    get filteredCustomers(){
      const q=this.custQuery.toLowerCase().trim(); if(!q) return this.customers.slice(0,200);
      return this.customers.filter(c => [c.email,c.name,c.company].join('|').toLowerCase().includes(q));
    },
    get filteredLeads(){
      const q=this.leadQuery.toLowerCase().trim(); if(!q) return this.leads.slice(0,200);
      return this.leads.filter(l => [l.email,l.name,l.company,l.notes].join('|').toLowerCase().includes(q));
    },
    get filteredServices(){
      const q=this.svcQuery.toLowerCase().trim(); if(!q) return this.services;
      return this.services.filter(s => [s.id,s.name,s.blurb,(s.includes||[]).join(' ')].join('|').toLowerCase().includes(q));
    },
    get filteredAddons(){
      const q=this.addonQuery.toLowerCase().trim();
      return this.addons.filter(a => (!this.addonSvcFilter || a.service_id===this.addonSvcFilter) &&
        [a.id,a.service_id,a.label,a.description,a.short,a.badge].join('|').toLowerCase().includes(q));
    },

    downloadCSV(rows, filename){
      if(!rows?.length) return;
      const headers = Object.keys(rows[0]);
      const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => {
        const v = r[h] ?? '';
        const s = typeof v === 'string' ? v : JSON.stringify(v);
        return `"${s.replace(/"/g,'""')}"`;
      }).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    },

    // ---------- toasts ----------
    flash(t){ this.toast={show:true,text:t}; setTimeout(()=>this.toast.show=false,1400); },

    // ---------- Services CRUD ----------
    openService(s=null){
      this.formError='';
      if(s){
        this.serviceForm = {
          id:s.id, _lockId:true, name:s.name||'', blurb:s.blurb||'',
          base_one_time_usd: Math.round((s.base_one_time_cents||0)/100),
          base_monthly_usd: Math.round((s.base_monthly_cents||0)/100),
          includes_csv: (s.includes||[]).join(', ')
        };
      } else {
        this.serviceForm = {id:'', _lockId:false, name:'', blurb:'', base_one_time_usd:0, base_monthly_usd:0, includes_csv:''};
      }
      this.modals.service=true;
    },
    async saveService(){
      try{
        const f=this.serviceForm;
        if(!f.id || !f.name){ this.formError='Key and Name are required'; return; }
        const payload={
          id:f.id.trim(),
          name:f.name.trim(),
          blurb:f.blurb||'',
          base_one_time_cents: Math.round(Number(f.base_one_time_usd||0)*100),
          base_monthly_cents: Math.round(Number(f.base_monthly_usd||0)*100),
          includes: f.includes_csv.split(',').map(x=>x.trim()).filter(Boolean)
        };
        const method = f._lockId ? 'PUT' : 'POST';
        const r = await fetch(API('services'),{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error(e.error||'Save failed'); }
        this.modals.service=false; this.flash('Service saved'); await this.refreshAll();
      }catch(e){ this.formError=e.message; }
    },
    async delService(id){
      if(!confirm('Delete service '+id+'? This may delete its add-ons.')) return;
      const r=await fetch(API('services') + '&id=' + encodeURIComponent(id),{method:'DELETE'});
      if(!r.ok){ alert('Delete failed'); return; }
      this.flash('Service deleted'); await this.refreshAll();
    },

    // ---------- Add-ons CRUD ----------
    openAddon(a=null){
      this.formError='';
      const firstService = this.services[0]?.id || '';
      if(a){
        this.addonForm = {
          id:a.id,_lockId:true,service_id:a.service_id,label:a.label||'',
          description:a.description||'', short:a.short||'', badge:a.badge||'',
          popular:!!a.popular,
          price_one_time_usd: Math.round((a.price_one_time_cents||0)/100),
          price_monthly_usd: Math.round((a.price_monthly_cents||0)/100)
        };
      } else {
        this.addonForm = {id:'',_lockId:false,service_id:firstService,label:'',description:'',short:'',badge:'',popular:false,price_one_time_usd:0,price_monthly_usd:0};
      }
      this.modals.addon=true;
    },
    async saveAddon(){
      try{
        const f=this.addonForm;
        if(!f.id || !f.service_id || !f.label){ this.formError='ID, Service, Label are required'; return; }
        const payload={
          id:f.id.trim(), service_id:f.service_id, label:f.label.trim(),
          description:f.description||'', short:f.short||'', badge:f.badge||'',
          popular: !!f.popular,
          price_one_time_cents: Math.round(Number(f.price_one_time_usd||0)*100),
          price_monthly_cents: Math.round(Number(f.price_monthly_usd||0)*100)
        };
        const r=await fetch(API('addons'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error(e.error||'Save failed'); }
        this.modals.addon=false; this.flash('Add-on saved'); await this.refreshAll();
      }catch(e){ this.formError=e.message; }
    },
    async delAddon(id){
      if(!confirm('Delete add-on '+id+'?')) return;
      const r=await fetch(API('addons') + '&id=' + encodeURIComponent(id),{method:'DELETE'});
      if(!r.ok){ alert('Delete failed'); return; }
      this.flash('Add-on deleted'); await this.refreshAll();
    },

    // ---------- Sync from site ----------
    async syncFromSite(){
      try{
        this.busy=true;
        for(const s of this.siteCatalog.services){
          const payload={
            id:s.key, name:s.name, blurb:s.blurb||'',
            base_one_time_cents: Math.round((s.base?.oneTime||0)*100),
            base_monthly_cents: Math.round((s.base?.monthly||0)*100),
            includes: s.includes||[]
          };
          const r=await fetch(API('services'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error(e.error||'Service upsert failed: '+s.key); }
        }
        for(const a of this.siteCatalog.addons){
          const [service_id,id,label,description,short,badge,popular,oneTime,monthly]=a;
          const payload={
            id, service_id, label, description, short, badge, popular:!!popular,
            price_one_time_cents: Math.round((oneTime||0)*100),
            price_monthly_cents: Math.round((monthly||0)*100)
          };
          const r=await fetch(API('addons'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error(e.error||'Add-on upsert failed: '+id); }
        }
        this.flash('Catalog synced from site'); await this.refreshAll();
      }catch(e){ alert(e.message||'Sync failed'); }finally{ this.busy=false; }
    },

    // ---------- Reorder (catalog) ----------
    async loadCatalog(){
      try{
        const r = await fetch(API('catalog'), { cache:'no-store' });
        if(!r.ok) throw new Error('Failed to load catalog');
        const j = await r.json();
        this.orderServices = Array.isArray(j.services) ? j.services.slice() : [];
        this.dirtyOrder = false;
        this.renderReorder();
        this.mountReorder(); // ensures Sortable exists when tab opens or reloads
      }catch(e){ console.error(e); this.flash('Could not load catalog'); }
    },
    renderReorder(){
      const listEl = document.getElementById('orderList');
      if(!listEl) return;
      listEl.innerHTML = '';
      const grip = `
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <circle cx="6" cy="7" r="1.5"/><circle cx="12" cy="7" r="1.5"/><circle cx="18" cy="7" r="1.5"/>
          <circle cx="6" cy="12" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="18" cy="12" r="1.5"/>
          <circle cx="6" cy="17" r="1.5"/><circle cx="12" cy="17" r="1.5"/><circle cx="18" cy="17" r="1.5"/>
        </svg>`;
      for(const s of this.orderServices){
        const li = document.createElement('li');
        li.dataset.key = s.key;
        li.className = 'group flex items-center gap-3 px-3 py-2 rounded-xl ring-1 ring-slate-200 bg-white hover:bg-slate-50';
        li.innerHTML = `
          <button type="button" class="drag-handle h-10 w-10 grid place-items-center rounded-lg bg-slate-100 ring-1 ring-slate-200 text-slate-600" aria-label="Drag">${grip}</button>
          <div class="flex-1 min-w-0">
            <div class="font-medium truncate">${this._esc(s.name||'Untitled')}</div>
            <div class="text-xs text-slate-500 truncate">${this._esc(s.blurb||'')}</div>
          </div>
          <div class="text-sm font-semibold text-slate-700 shrink-0">$${(s.base?.oneTime ?? 0)}</div>
          <div class="hidden sm:flex gap-1 ml-2">
            <button type="button" class="rounded-md px-2 py-1 ring-1 ring-slate-200 text-xs" data-up>↑</button>
            <button type="button" class="rounded-md px-2 py-1 ring-1 ring-slate-200 text-xs" data-down>↓</button>
          </div>`;
        listEl.appendChild(li);
      }
      // buttons
      listEl.querySelectorAll('[data-up]').forEach(btn=>btn.addEventListener('click', e=>this.bumpOrder(e,-1)));
      listEl.querySelectorAll('[data-down]').forEach(btn=>btn.addEventListener('click', e=>this.bumpOrder(e,+1)));
    },
    mountReorder(){
      const listEl = document.getElementById('orderList');
      const scrollEl = document.getElementById('orderScroll');
      if(!listEl || this._sortableInited) return;
      Sortable.create(listEl, {
        handle: '.drag-handle',
        animation: 180,
        easing: 'cubic-bezier(.2,.7,.3,1)',
        ghostClass: 'drag-ghost',
        dragClass: 'drag-dragging',
        scroll: scrollEl,
        scrollSensitivity: 80,
        scrollSpeed: 14,
        bubbleScroll: true,
        onEnd: () => {
          const keys = Array.from(listEl.children).map(el => el.dataset.key);
          this.orderServices.sort((a,b)=> keys.indexOf(a.key) - keys.indexOf(b.key));
          this.dirtyOrder = true;
        }
      });
      this._sortableInited = true;
    },
    bumpOrder(e, delta){
      const li = e.currentTarget.closest('li');
      const key = li?.dataset?.key;
      const i = this.orderServices.findIndex(x => x.key === key);
      const j = i + delta;
      if (i < 0 || j < 0 || j >= this.orderServices.length) return;
      const [item] = this.orderServices.splice(i,1);
      this.orderServices.splice(j,0,item);
      this.renderReorder();
      this.dirtyOrder = true;
      li.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    },
    async saveCatalog(){
      try{
        const res = await fetch(API('save-catalog'), {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ services: this.orderServices })
        });
        const j = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(j.error||'Save failed');
        this.dirtyOrder = false;
        this.flash('Order saved. Homepage will update.');
      }catch(e){ console.error(e); this.flash(e.message||'Save failed'); }
    },
    _esc(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
  }
}
</script>
</body>
</html>
