<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin • 1CoastMedia</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<style>
  body{font-family:Inter,ui-sans-serif,system-ui}
  .card{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:1rem;box-shadow:0 8px 24px rgba(2,6,23,.06)}
  .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
</style>
</head>
<body class="bg-slate-50" x-data="adminApp()" x-init="init()">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/assets/1coastmedia_logo_A_primary_mark_2048.jpg" alt="" class="h-8 w-8 rounded"/>
        <div class="font-extrabold">1CoastMedia — Admin</div>
      </div>
      <div class="text-sm text-slate-600">
        <template x-if="me"><span>Signed in as <b x-text="me"></b></span></template>
        <button @click="logout" class="ml-3 px-3 py-1.5 rounded bg-slate-900 text-white text-sm">Logout</button>
      </div>
    </div>
  </header>

  <!-- Login -->
  <section class="max-w-md mx-auto p-6" x-show="!authed" x-transition>
    <div class="card p-6">
      <h1 class="text-xl font-bold">Admin login</h1>
      <p class="text-sm text-slate-500 mt-1">Use the credentials from your Vercel env vars.</p>
      <div class="mt-4 space-y-3">
        <div>
          <label class="text-xs text-slate-500">Username</label>
          <input x-model="login.username" class="w-full mt-1 rounded border border-slate-300 px-3 py-2"/>
        </div>
        <div>
          <label class="text-xs text-slate-500">Password</label>
          <input x-model="login.password" type="password" class="w-full mt-1 rounded border border-slate-300 px-3 py-2"/>
        </div>
        <button @click="doLogin" class="w-full mt-2 rounded bg-indigo-600 text-white font-semibold px-4 py-2">Sign in</button>
      </div>
      <p class="text-xs text-rose-600 mt-3" x-text="error"></p>
    </div>
  </section>

  <!-- Dashboard -->
  <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-6" x-show="authed" x-transition>
    <!-- KPIs -->
    <section>
      <h2 class="text-lg font-bold mb-3">Overview</h2>
      <div class="grid-auto">
        <div class="card p-4"><div class="text-xs text-slate-500">Revenue</div><div class="text-2xl font-extrabold" x-text="fmtUSD(kpis.revenue_cents)"></div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Paid Orders</div><div class="text-2xl font-extrabold" x-text="kpis.orders"></div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Customers</div><div class="text-2xl font-extrabold" x-text="kpis.customers"></div></div>
        <div class="card p-4"><div class="text-xs text-slate-500">Pageviews</div><div class="text-2xl font-extrabold" x-text="kpis.pageviews"></div></div>
      </div>
    </section>

    <!-- Orders -->
    <section>
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Recent Orders</h2>
      </div>
      <div class="card overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-600">
            <tr>
              <th class="text-left p-2">Date</th>
              <th class="text-left p-2">Customer</th>
              <th class="text-left p-2">Plan</th>
              <th class="text-left p-2">Status</th>
              <th class="text-left p-2">Total</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="o in orders" :key="o.id">
              <tr class="border-t">
                <td class="p-2" x-text="new Date(o.created_at).toLocaleString()"></td>
                <td class="p-2" x-text="o.contact_email || o.customer_email || '—'"></td>
                <td class="p-2" x-text="o.plan"></td>
                <td class="p-2" x-text="o.status"></td>
                <td class="p-2" x-text="fmtUSD(o.total_cents)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Customers and Leads -->
    <section class="grid md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-lg font-bold mb-2">Customers</h2>
        <div class="card overflow-auto max-h-[24rem]">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-600">
              <tr><th class="text-left p-2">When</th><th class="text-left p-2">Name</th><th class="text-left p-2">Email</th><th class="text-left p-2">Company</th></tr>
            </thead>
            <tbody>
              <template x-for="c in customers" :key="c.id">
                <tr class="border-t">
                  <td class="p-2" x-text="new Date(c.created_at).toLocaleDateString()"></td>
                  <td class="p-2" x-text="c.name || '—'"></td>
                  <td class="p-2" x-text="c.email"></td>
                  <td class="p-2" x-text="c.company || '—'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <h2 class="text-lg font-bold mb-2">Leads</h2>
        <div class="card overflow-auto max-h-[24rem]">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-600">
              <tr><th class="text-left p-2">When</th><th class="text-left p-2">Name</th><th class="text-left p-2">Email</th><th class="text-left p-2">Message</th></tr>
            </thead>
            <tbody>
              <template x-for="l in leads" :key="l.id">
                <tr class="border-t">
                  <td class="p-2" x-text="new Date(l.created_at).toLocaleDateString()"></td>
                  <td class="p-2" x-text="l.name || '—'"></td>
                  <td class="p-2" x-text="l.email || '—'"></td>
                  <td class="p-2" x-text="l.message || '—'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Catalog (Services & Add-ons CRUD) -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- Services -->
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold">Base Services</h2>
          <button class="px-3 py-1.5 text-sm rounded bg-slate-900 text-white" @click="newService()">+ New</button>
        </div>
        <div class="space-y-3">
          <template x-for="s in services" :key="s.id">
            <div class="border rounded p-3">
              <div class="font-semibold" x-text="s.name + ' (' + s.id + ') '"></div>
              <div class="text-xs text-slate-500" x-text="s.blurb"></div>
              <div class="text-xs mt-1">One-time: <b x-text="fmtUSD(s.base_one_time_cents)"></b> • Monthly: <b x-text="fmtUSD(s.base_monthly_cents)"></b></div>
              <div class="mt-2 flex gap-2">
                <button class="px-2 py-1 text-xs rounded bg-indigo-600 text-white" @click="editService(s)">Edit</button>
                <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white" @click="delService(s.id)">Delete</button>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Add-ons -->
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold">Add-ons</h2>
          <button class="px-3 py-1.5 text-sm rounded bg-slate-900 text-white" @click="newAddon()">+ New</button>
        </div>
        <div class="space-y-3">
          <template x-for="a in addons" :key="a.id">
            <div class="border rounded p-3">
              <div class="font-semibold" x-text="a.label + ' (' + a.id + ') '"></div>
              <div class="text-xs text-slate-500" x-text="a.description"></div>
              <div class="text-xs mt-1">Service: <b x-text="a.service_id"></b> • One-time: <b x-text="fmtUSD(a.price_one_time_cents)"></b> • Monthly: <b x-text="fmtUSD(a.price_monthly_cents)"></b></div>
              <div class="mt-2 flex gap-2">
                <button class="px-2 py-1 text-xs rounded bg-indigo-600 text-white" @click="editAddon(a)">Edit</button>
                <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white" @click="delAddon(a.id)">Delete</button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </section>
  </main>

  <script>
    function adminApp(){
      return {
        authed:false,
        me:null,
        error:'',
        login:{username:'',password:''},
        kpis:{revenue_cents:0,orders:0,customers:0,pageviews:0},
        orders:[],
        customers:[],
        leads:[],
        services:[],
        addons:[],

        async init(){
          await this.checkAuth();
          if(this.authed) await this.refreshAll();
        },
        async checkAuth(){
          try{
            const r = await fetch('/api/admin/me'); if(!r.ok) throw 0;
            const j = await r.json(); this.me = j.user; this.authed = true;
          }catch{ this.authed = false; }
        },
        async doLogin(){
          this.error='';
          const r = await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(this.login)});
          if(!r.ok){ this.error='Invalid login'; return; }
          this.authed=true; this.me=this.login.username; this.login={username:'',password:''};
          await this.refreshAll();
        },
        async logout(){ await fetch('/api/admin/logout'); location.reload(); },

        async refreshAll(){
          const [m, o, c, l, s, a] = await Promise.all([
            fetch('/api/admin/metrics').then(r=>r.json()),
            fetch('/api/admin/orders').then(r=>r.json()),
            fetch('/api/admin/customers').then(r=>r.json()),
            fetch('/api/admin/leads').then(r=>r.json()),
            fetch('/api/admin/services').then(r=>r.json()),
            fetch('/api/admin/addons').then(r=>r.json()),
          ]);
          this.kpis=m; this.orders=o; this.customers=c; this.leads=l; this.services=s; this.addons=a;
        },

        // Money
        fmtUSD(cents){ return (cents/100).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}); },

        // Services CRUD
        async newService(){
          const id = prompt('Service key (e.g. web, video):'); if(!id) return;
          const name = prompt('Display name:'); if(!name) return;
          const blurb = prompt('Blurb (optional):')||'';
          const ot = Number(prompt('One-time price (USD, whole number):')||'0')*100;
          const mo = Number(prompt('Monthly price (USD, whole number):')||'0')*100;
          const payload = { id, name, blurb, base_one_time_cents:ot, base_monthly_cents:mo, includes:[] };
          await fetch('/api/admin/services',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          await this.refreshAll();
        },
        async editService(s){
          const name = prompt('Display name:', s.name)||s.name;
          const blurb = prompt('Blurb:', s.blurb||'')||'';
          const ot = Number(prompt('One-time price (USD):', (s.base_one_time_cents/100))||s.base_one_time_cents/100)*100;
          const mo = Number(prompt('Monthly price (USD):', (s.base_monthly_cents/100))||s.base_monthly_cents/100)*100;
          const payload = { id:s.id, name, blurb, base_one_time_cents:ot, base_monthly_cents:mo, includes:s.includes||[] };
          await fetch('/api/admin/services',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          await this.refreshAll();
        },
        async delService(id){
          if(!confirm('Delete service '+id+'? This also deletes its add-ons.')) return;
          await fetch('/api/admin/services?id='+encodeURIComponent(id),{method:'DELETE'});
          await this.refreshAll();
        },

        // Addons CRUD
        async newAddon(){
          const id = prompt('Addon id (e.g. web-seo):'); if(!id) return;
          const service_id = prompt('Service key this belongs to:'); if(!service_id) return;
          const label = prompt('Label:'); if(!label) return;
          const description = prompt('Description (optional):')||'';
          const short = prompt('Short (optional):')||'';
          const badge = prompt('Badge (optional):')||'';
          const ot = Number(prompt('One-time (USD):')||'0')*100;
          const mo = Number(prompt('Monthly (USD):')||'0')*100;
          const payload = { id, service_id, label, description, short, badge, popular:false, price_one_time_cents:ot, price_monthly_cents:mo };
          await fetch('/api/admin/addons',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          await this.refreshAll();
        },
        async editAddon(a){
          const service_id = prompt('Service key:', a.service_id)||a.service_id;
          const label = prompt('Label:', a.label)||a.label;
          const description = prompt('Description:', a.description||'')||'';
          const short = prompt('Short:', a.short||'')||'';
          const badge = prompt('Badge:', a.badge||'')||'';
          const ot = Number(prompt('One-time (USD):', a.price_one_time_cents/100)||a.price_one_time_cents/100)*100;
          const mo = Number(prompt('Monthly (USD):', a.price_monthly_cents/100)||a.price_monthly_cents/100)*100;
          const payload = { id:a.id, service_id, label, description, short, badge, price_one_time_cents:ot, price_monthly_cents:mo };
          await fetch('/api/admin/addons',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); // upsert
          await this.refreshAll();
        },
        async delAddon(id){
          if(!confirm('Delete add-on '+id+'?')) return;
          await fetch('/api/admin/addons?id='+encodeURIComponent(id),{method:'DELETE'});
          await this.refreshAll();
        },
      }
    }
  </script>
</body>
</html>
