<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin • 1CoastMedia</title>

<link rel="icon" href="/assets/1coastmedia_logo_A_primary_mark_2048.jpg"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>

<!-- Tailwind (admin-only) -->
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={theme:{extend:{}}}</script>

<!-- Alpine for state -->
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<style>
  [x-cloak]{display:none!important}
  body{font-family:Inter,ui-sans-serif,system-ui}
  .card{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:1rem;box-shadow:0 10px 28px rgba(2,6,23,.06)}
  .input{width:100%;border:1px solid rgba(15,23,42,.12);border-radius:.5rem;padding:.6rem .8rem}
  .label{font-size:.75rem;color:#64748b}
</style>
</head>

<body 
  <body
  class="bg-slate-50"
  x-data="adminApp()"
  x-init="boot()"
  x-cloak
  :class="{'overflow-hidden': modals.service || modals.addon}"
>
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/assets/1coastmedia_logo_A_primary_mark_2048.jpg" class="h-8 w-8 rounded" alt="1CoastMedia"/>
        <div class="font-extrabold tracking-tight">1CoastMedia — Admin</div>
      </div>
      <div class="text-sm text-slate-600">
        <template x-if="authed"><span>Signed in as <b x-text="me||'admin'"></b></span></template>
        <button x-show="authed" @click="logout" class="ml-3 px-3 py-1.5 rounded bg-slate-900 text-white text-sm">Logout</button>
      </div>
    </div>
  </header>

  <!-- Error banner -->
  <div x-show="globalError" class="bg-rose-50 text-rose-700 border-y border-rose-200">
    <div class="max-w-7xl mx-auto px-4 py-2 text-sm">
      <strong>Error:</strong> <span x-text="globalError"></span>
    </div>
  </div>

  <!-- Login -->
  <section class="max-w-md mx-auto p-6" x-show="!authed" x-transition>
    <div class="card p-6">
      <h1 class="text-xl font-bold">Admin login</h1>
      <p class="text-sm text-slate-500 mt-1">Use the credentials set in Vercel env vars.</p>
      <div class="mt-4 space-y-3">
        <div><label class="label">Username</label><input x-model="login.username" class="input" autocomplete="username"/></div>
        <div><label class="label">Password</label><input x-model="login.password" type="password" class="input" autocomplete="current-password"/></div>
        <button @click="doLogin" class="w-full mt-2 rounded bg-indigo-600 text-white font-semibold px-4 py-2">Sign in</button>
      </div>
      <p class="text-xs text-rose-600 mt-3" x-text="error"></p>
    </div>
  </section>

  <!-- Dashboard -->
  <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-6" x-show="authed" x-transition>
    <!-- Actions -->
    <section class="flex items-center justify-between">
      <h2 class="text-lg font-bold">Overview</h2>
      <div class="flex gap-2">
        <button class="px-3 py-1.5 rounded bg-emerald-600 text-white text-sm" @click="syncFromSite" :disabled="busy">
          <span x-show="!busy">Sync catalog from site</span>
          <span x-show="busy" class="inline-flex items-center gap-2"><span class="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span> Working…</span>
        </button>
        <button class="px-3 py-1.5 rounded bg-slate-900 text-white text-sm" @click="refreshAll">Refresh</button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-4"><div class="text-xs text-slate-500">Revenue</div><div class="text-2xl font-extrabold" x-text="fmtUSD(kpis.revenue_cents)"></div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Paid Orders</div><div class="text-2xl font-extrabold" x-text="kpis.orders"></div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Customers</div><div class="text-2xl font-extrabold" x-text="kpis.customers"></div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Pageviews</div><div class="text-2xl font-extrabold" x-text="kpis.pageviews"></div></div>
    </section>

    <!-- Orders -->
    <section>
      <div class="flex items-center justify-between mb-2"><h2 class="text-lg font-bold">Recent Orders</h2></div>
      <div class="card overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-600">
            <tr><th class="text-left p-2">Date</th><th class="text-left p-2">Customer</th><th class="text-left p-2">Plan</th><th class="text-left p-2">Status</th><th class="text-left p-2">Total</th></tr>
          </thead>
          <tbody>
            <template x-for="o in orders" :key="o.id">
              <tr class="border-t">
                <td class="p-2" x-text="new Date(o.created_at).toLocaleString()"></td>
                <td class="p-2" x-text="o.contact_email || '—'"></td>
                <td class="p-2" x-text="o.plan"></td>
                <td class="p-2" x-text="o.status"></td>
                <td class="p-2" x-text="fmtUSD(o.total_cents)"></td>
              </tr>
            </template>
            <tr x-show="orders.length===0"><td colspan="5" class="p-3 text-center text-slate-500">No orders yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Reorder Base Services (library-free drag & drop + arrows + keyboard) -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <div>
          <h3 class="text-lg font-semibold">Homepage order</h3>
          <p class="text-xs text-slate-500">
            Drag a row, use ↑/↓/Home/End keys, or click ⤒ ↑ ↓ ⤓. Click “Save Order”.
          </p>
        </div>
        <div class="flex gap-2">
          <button id="orderReload" class="rounded-lg ring-1 ring-slate-200 bg-white px-3 py-2 text-sm">Reload</button>
          <button id="orderSave" class="rounded-lg bg-indigo-600 text-white px-4 py-2 font-semibold disabled:opacity-50" disabled>Saved</button>
        </div>
      </div>

      <div class="card p-3 max-h-[60vh] overflow-auto">
        <ul id="orderList" class="grid gap-2"></ul>
      </div>

      <p id="orderMsg" class="mt-2 text-xs text-slate-500"></p>

      <!-- Floating Save button for long lists / mobile -->
      <button id="orderSaveFab"
              class="hidden fixed bottom-6 right-6 rounded-full px-5 py-3 bg-indigo-600 text-white font-semibold shadow-lg shadow-indigo-600/30">
        Save Order
      </button>
    </section>

    <!-- Services -->
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold">Base Services</h2>
        <button class="px-3 py-1.5 text-sm rounded bg-slate-900 text-white" @click="openService()">+ New</button>
      </div>
      <div class="space-y-3">
        <template x-for="s in services" :key="s.id">
          <div class="border rounded p-3">
            <div class="font-semibold" x-text="s.name + ' (' + s.id + ')'"></div>
            <div class="text-xs text-slate-500" x-text="s.blurb || ''"></div>
            <div class="text-xs mt-1">One-time: <b x-text="fmtUSD(s.base_one_time_cents)"></b> • Monthly: <b x-text="fmtUSD(s.base_monthly_cents)"></b></div>
            <div class="text-xs mt-1">Includes: <span x-text="(s.includes||[]).join(', ') || '—'"></span></div>
            <div class="mt-2 flex gap-2">
              <button class="px-2 py-1 text-xs rounded bg-indigo-600 text-white" @click="openService(s)">Edit</button>
              <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white" @click="delService(s.id)">Delete</button>
            </div>
          </div>
        </template>
        <div x-show="services.length===0" class="text-sm text-slate-500">No services found.</div>
      </div>
    </div>

    <!-- Add-ons -->
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold">Add-ons</h2>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500">Filter</label>
          <select class="input !py-1 !h-8 !text-sm !w-44" x-model="addonFilter">
            <option value="">All services</option>
            <template x-for="s in services" :key="'f-'+s.id"><option :value="s.id" x-text="s.id"></option></template>
          </select>
          <button class="px-3 py-1.5 text-sm rounded bg-slate-900 text-white" @click="openAddon()">+ New</button>
        </div>
      </div>
      <div class="space-y-3">
        <template x-for="a in filteredAddons" :key="a.id">
          <div class="border rounded p-3">
            <div class="font-semibold" x-text="a.label + ' (' + a.id + ')'"></div>
            <div class="text-xs text-slate-500" x-text="a.description || ''"></div>
            <div class="text-xs mt-1">
              Service: <b x-text="a.service_id"></b> • One-time: <b x-text="fmtUSD(a.price_one_time_cents)"></b> • Monthly: <b x-text="fmtUSD(a.price_monthly_cents)"></b>
              <span class="ml-2 px-2 py-0.5 rounded bg-indigo-50 text-indigo-700 text-[11px]" x-show="a.popular">Popular</span>
            </div>
            <div class="mt-2 flex gap-2">
              <button class="px-2 py-1 text-xs rounded bg-indigo-600 text-white" @click="openAddon(a)">Edit</button>
              <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white" @click="delAddon(a.id)">Delete</button>
            </div>
          </div>
        </template>
        <div x-show="filteredAddons.length===0" class="text-sm text-slate-500">No add-ons.</div>
      </div>
    </div>
  </main>

<!-- SERVICE MODAL (scrollable) -->
<div
  class="fixed inset-0 z-50 bg-slate-900/50 overflow-y-auto p-4 sm:p-6"
  :class="{'hidden': !modals.service}"
  role="dialog" aria-modal="true"
  x-transition
>
  <div
    class="card mx-auto w-full max-w-2xl bg-white"
    style="max-height: 90vh; overflow-y: auto;"
  >
    <div class="sticky top-0 z-10 bg-white/95 backdrop-blur px-5 pt-5 pb-3 border-b">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold" x-text="serviceForm._lockId ? 'Edit Base Service' : 'New Base Service'"></h3>
        <button class="h-9 w-9 rounded hover:bg-slate-100 grid place-items-center" @click="modals.service=false" aria-label="Close">✕</button>
      </div>
    </div>

    <div class="px-5 pb-5">
      <p class="text-sm text-slate-500 mt-1">
        A “Base Service” is one of the tiles on your homepage. Prices are in <b>USD</b>.
      </p>

      <!-- form content (unchanged) -->
      <!-- START: your service form fields -->
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="md:col-span-2">
          <label class="label">Public Name <span class="text-rose-600">*</span></label>
          <input class="input" x-model.trim="serviceForm.name" placeholder="e.g., Web & App" @input="maybeSuggestServiceKey()"/>
          <p class="text-xs text-slate-500 mt-1">What customers will see on the tile.</p>
        </div>

        <div class="md:col-span-2">
          <label class="label">Short Description (1 sentence)</label>
          <input class="input" x-model.trim="serviceForm.blurb" placeholder="e.g., Launch a clean, mobile-first site fast."/>
          <div class="flex items-center justify-between text-xs text-slate-500 mt-1">
            <span>Keep it short and benefit-focused.</span>
            <span x-text="serviceForm.blurb?.length || 0"></span>
          </div>
        </div>

        <div>
          <label class="label">One-time Base Price (USD)</label>
          <input type="number" min="0" class="input" x-model.number="serviceForm.base_one_time_usd" placeholder="e.g., 300"/>
          <p class="text-xs text-slate-500 mt-1">Shown when visitors pick “One-time”.</p>
        </div>

        <div>
          <label class="label">Monthly Base Price (USD)</label>
          <input type="number" min="0" class="input" x-model.number="serviceForm.base_monthly_usd" placeholder="e.g., 500"/>
          <p class="text-xs text-slate-500 mt-1">Shown when visitors pick “Monthly”.</p>
        </div>

        <div class="md:col-span-2">
          <label class="label">What’s included (bullets)</label>
          <div class="flex gap-2 mt-1">
            <input class="input" x-model.trim="serviceForm.includes_input" placeholder="e.g., Kickoff & setup" @keydown.enter.prevent="addIncludeChip()"/>
            <button class="px-3 rounded bg-slate-900 text-white text-sm" type="button" @click="addIncludeChip()">Add</button>
          </div>

          <div class="flex flex-wrap gap-2 mt-2">
            <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="quickInclude('Kickoff & setup')">Kickoff & setup</button>
            <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="quickInclude('Landing page (3–5 sections)')">Landing page (3–5 sections)</button>
            <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="quickInclude('Light copy help')">Light copy help</button>
          </div>

          <div class="mt-2 flex flex-wrap gap-2">
            <template x-for="(it, i) in serviceForm.includes_list" :key="'inc-'+i">
              <span class="inline-flex items-center gap-2 px-2 py-1 text-xs rounded-full bg-slate-100 ring-1 ring-slate-200">
                <span x-text="it"></span>
                <button class="text-slate-500 hover:text-rose-600" @click="removeIncludeChip(i)" aria-label="Remove">✕</button>
              </span>
            </template>
            <span x-show="serviceForm.includes_list.length===0" class="text-xs text-slate-400">No bullets yet.</span>
          </div>
        </div>

        <div class="md:col-span-2">
          <details class="rounded-lg ring-1 ring-slate-200 bg-slate-50 px-3 py-2">
            <summary class="cursor-pointer text-sm font-semibold">Advanced: Service Key (ID)</summary>
            <div class="mt-2">
              <label class="label">Key (no spaces, used internally)</label>
              <input class="input" x-model.trim="serviceForm.id" :disabled="!!serviceForm._lockId" placeholder="e.g., web"/>
              <p class="text-xs text-slate-500 mt-1">Keep as-is for existing services.</p>
            </div>
          </details>
        </div>
      </div>

      <div class="mt-4">
        <div class="text-xs text-slate-500 mb-1">Preview</div>
        <div class="rounded-lg ring-1 ring-slate-200 p-3">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] uppercase rounded bg-slate-100 ring-1 ring-slate-200 px-2 py-0.5 inline-block">One-time / Monthly</div>
              <div class="text-base font-semibold mt-1" x-text="serviceForm.name || 'Untitled'"></div>
              <div class="text-sm text-slate-600" x-text="serviceForm.blurb || 'Short description appears here.'"></div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Base</div>
              <div class="font-bold" x-text="'$'+(serviceForm.base_one_time_usd||0) + ' / $' + (serviceForm.base_monthly_usd||0)"></div>
            </div>
          </div>
          <ul class="mt-2 text-sm list-disc pl-5">
            <template x-for="(it,i) in serviceForm.includes_list" :key="'pv-'+i">
              <li x-text="it"></li>
            </template>
            <li x-show="serviceForm.includes_list.length===0" class="text-slate-400">No bullets yet.</li>
          </ul>
        </div>
      </div>
      <!-- END: form content -->

      <div class="sticky bottom-0 bg-white/95 backdrop-blur pt-3 mt-4">
        <div class="flex justify-end gap-2 border-t pt-3">
          <button class="px-3 py-2 rounded border" @click="modals.service=false">Cancel</button>
          <button class="px-3 py-2 rounded bg-indigo-600 text-white disabled:opacity-50"
                  :disabled="!canSaveService()" @click="saveService">Save</button>
        </div>
        <p class="text-xs text-rose-600 mt-2" x-text="formError"></p>
      </div>
    </div>
  </div>
</div>


          <!-- Quick examples -->
          <div class="flex flex-wrap gap-2 mt-2">
            <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="quickInclude('Kickoff & setup')">Kickoff & setup</button>
            <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="quickInclude('Landing page (3–5 sections)')">Landing page (3–5 sections)</button>
            <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="quickInclude('Light copy help')">Light copy help</button>
          </div>

          <!-- Chips -->
          <div class="mt-2 flex flex-wrap gap-2">
            <template x-for="(it, i) in serviceForm.includes_list" :key="'inc-'+i">
              <span class="inline-flex items-center gap-2 px-2 py-1 text-xs rounded-full bg-slate-100 ring-1 ring-slate-200">
                <span x-text="it"></span>
                <button class="text-slate-500 hover:text-rose-600" @click="removeIncludeChip(i)" aria-label="Remove">✕</button>
              </span>
            </template>
            <span x-show="serviceForm.includes_list.length===0" class="text-xs text-slate-400">No bullets yet.</span>
          </div>
        </div>

        <div class="md:col-span-2">
          <details class="rounded-lg ring-1 ring-slate-200 bg-slate-50 px-3 py-2">
            <summary class="cursor-pointer text-sm font-semibold">Advanced: Service Key (ID)</summary>
            <div class="mt-2">
              <label class="label">Key (no spaces, used internally)</label>
              <input class="input" x-model.trim="serviceForm.id" :disabled="!!serviceForm._lockId" placeholder="e.g., web"/>
              <p class="text-xs text-slate-500 mt-1">Keep as-is for existing services. Changing a live key can orphan related add-ons.</p>
            </div>
          </details>
        </div>
      </div>

      <!-- Live preview -->
      <div class="mt-4">
        <div class="text-xs text-slate-500 mb-1">Preview</div>
        <div class="rounded-lg ring-1 ring-slate-200 p-3">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] uppercase rounded bg-slate-100 ring-1 ring-slate-200 px-2 py-0.5 inline-block">One-time / Monthly</div>
              <div class="text-base font-semibold mt-1" x-text="serviceForm.name || 'Untitled'"></div>
              <div class="text-sm text-slate-600" x-text="serviceForm.blurb || 'Short description appears here.'"></div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Base</div>
              <div class="font-bold" x-text="'$'+(serviceForm.base_one_time_usd||0) + ' / $' + (serviceForm.base_monthly_usd||0)"></div>
            </div>
          </div>
          <ul class="mt-2 text-sm list-disc pl-5">
            <template x-for="(it,i) in serviceForm.includes_list" :key="'pv-'+i">
              <li x-text="it"></li>
            </template>
            <li x-show="serviceForm.includes_list.length===0" class="text-slate-400">No bullets yet.</li>
          </ul>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="px-3 py-2 rounded border" @click="modals.service=false">Cancel</button>
        <button class="px-3 py-2 rounded bg-indigo-600 text-white disabled:opacity-50"
                :disabled="!canSaveService()" @click="saveService">Save</button>
      </div>
      <p class="text-xs text-rose-600 mt-2" x-text="formError"></p>
    </div>
  </div>

  <!-- ADD-ON MODAL (scrollable) -->
<div
  class="fixed inset-0 z-50 bg-slate-900/50 overflow-y-auto p-4 sm:p-6"
  :class="{'hidden': !modals.addon}"
  role="dialog" aria-modal="true"
  x-transition
>
  <div
    class="card mx-auto w-full max-w-2xl bg-white"
    style="max-height: 90vh; overflow-y: auto;"
  >
    <div class="sticky top-0 z-10 bg-white/95 backdrop-blur px-5 pt-5 pb-3 border-b">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold" x-text="addonForm._lockId ? 'Edit Add-on' : 'New Add-on'"></h3>
        <button class="h-9 w-9 rounded hover:bg-slate-100 grid place-items-center" @click="modals.addon=false" aria-label="Close">✕</button>
      </div>
    </div>

    <div class="px-5 pb-5">
      <p class="text-sm text-slate-500 mt-1">
        Add-ons attach to a specific base service (e.g., “Web & App → SEO Basics”).
      </p>

      <!-- form content (unchanged) -->
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="md:col-span-2">
          <label class="label">Which Base Service? <span class="text-rose-600">*</span></label>
          <select class="input" x-model="addonForm.service_id" @change="maybeSuggestAddonId()">
            <template x-for="s in services" :key="'sopt-'+s.id">
              <option :value="s.id" x-text="s.name + ' (' + s.id + ')'"></option>
            </template>
          </select>
          <p class="text-xs text-slate-500 mt-1">Choose where this add-on will appear.</p>
        </div>

        <div class="md:col-span-2">
          <label class="label">Add-on Name <span class="text-rose-600">*</span></label>
          <input class="input" x-model.trim="addonForm.label" placeholder="e.g., SEO Basics" @input="maybeSuggestAddonId()"/>
          <p class="text-xs text-slate-500 mt-1">Short, customer-friendly name.</p>
        </div>

        <div>
          <label class="label">Short Tagline (optional)</label>
          <input class="input" x-model.trim="addonForm.short" placeholder="e.g., Quick search wins"/>
          <div class="flex items-center justify-between text-xs text-slate-500 mt-1">
            <span>Used as a brief hint in cards.</span>
            <span x-text="addonForm.short?.length || 0"></span>
          </div>
        </div>

        <div>
          <label class="label">Badge (optional)</label>
          <div class="flex gap-2">
            <input class="input" x-model.trim="addonForm.badge" placeholder="e.g., Quick win"/>
            <div class="hidden md:flex gap-1">
              <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="addonForm.badge='Quick win'">Quick win</button>
              <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="addonForm.badge='Premium'">Premium</button>
              <button type="button" class="px-2 py-1 text-xs rounded ring-1 ring-slate-200" @click="addonForm.badge='Conversion'">Conversion</button>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-1">Tiny label (e.g., “Premium”, “Quick win”).</p>
        </div>

        <div class="md:col-span-2">
          <label class="label">Detailed Description</label>
          <textarea class="input" x-model.trim="addonForm.description" placeholder="What exactly is included, in a sentence or two."></textarea>
          <div class="flex items-center justify-between text-xs text-slate-500 mt-1">
            <span>Be specific about deliverables.</span>
            <span x-text="addonForm.description?.length || 0"></span>
          </div>
        </div>

        <div>
          <label class="label">One-time Price (USD)</label>
          <input type="number" min="0" class="input" x-model.number="addonForm.price_one_time_usd" placeholder="e.g., 150"/>
        </div>

        <div>
          <label class="label">Monthly Price (USD)</label>
          <input type="number" min="0" class="input" x-model.number="addonForm.price_monthly_usd" placeholder="e.g., 150"/>
        </div>

        <div class="md:col-span-2">
          <label class="inline-flex items-center gap-2 text-sm">
            <input type="checkbox" x-model="addonForm.popular"/>
            <span>Mark as <b>Popular</b></span>
          </label>
        </div>

        <div class="md:col-span-2">
          <details class="rounded-lg ring-1 ring-slate-200 bg-slate-50 px-3 py-2">
            <summary class="cursor-pointer text-sm font-semibold">Advanced: Add-on ID</summary>
            <div class="mt-2">
              <label class="label">ID (no spaces, used internally)</label>
              <input class="input" x-model.trim="addonForm.id" :disabled="!!addonForm._lockId" placeholder="e.g., web-seo"/>
              <p class="text-xs text-slate-500 mt-1">Keep as-is for existing add-ons.</p>
            </div>
          </details>
        </div>
      </div>
      <!-- END: form content -->

      <div class="sticky bottom-0 bg-white/95 backdrop-blur pt-3 mt-4">
        <div class="flex justify-end gap-2 border-t pt-3">
          <button class="px-3 py-2 rounded border" @click="modals.addon=false">Cancel</button>
          <button class="px-3 py-2 rounded bg-indigo-600 text-white disabled:opacity-50"
                  :disabled="!canSaveAddon()" @click="saveAddon">Save</button>
        </div>
        <p class="text-xs text-rose-600 mt-2" x-text="formError"></p>
      </div>
    </div>
  </div>
</div>


      <!-- Live preview -->
      <div class="mt-4">
        <div class="text-xs text-slate-500 mb-1">Preview</div>
        <div class="rounded-lg ring-1 ring-slate-200 p-3">
          <div class="flex items-center justify-between">
            <div class="min-w-0">
              <div class="font-medium truncate" x-text="addonForm.label || 'Add-on name'"></div>
              <div class="text-[11px] text-slate-500 mt-0.5 inline-flex items-center gap-2">
                <span class="rounded-full bg-slate-100 ring-1 ring-slate-200 px-2 py-0.5 uppercase tracking-wide" x-text="addonForm.badge || 'Badge'"></span>
                <span class="rounded-full bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200 px-2 py-0.5" x-show="addonForm.popular">Popular</span>
              </div>
            </div>
            <div class="text-sm font-semibold whitespace-nowrap">
              <span x-text="'$'+(addonForm.price_one_time_usd||0)"></span>
              <span class="text-slate-400"> / </span>
              <span x-text="'$'+(addonForm.price_monthly_usd||0)"></span>
            </div>
          </div>
          <div class="mt-2 text-xs text-slate-500" x-text="addonForm.description || 'Description appears here.'"></div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="px-3 py-2 rounded border" @click="modals.addon=false">Cancel</button>
        <button class="px-3 py-2 rounded bg-indigo-600 text-white disabled:opacity-50"
                :disabled="!canSaveAddon()" @click="saveAddon">Save</button>
      </div>
      <p class="text-xs text-rose-600 mt-2" x-text="formError"></p>
    </div>
  </div>

<script>
/* ====================== API HELPERS ====================== */
const apiURL = (r, params={}) => {
  const sp = new URLSearchParams({ r, ...params });
  return '/api/admin?' + sp.toString();
};
const API = (r, init={}, params={}) =>
  fetch(apiURL(r, params), { credentials: 'include', ...init });

/* ====================== CORE STATE (Alpine) ====================== */
function adminApp(){
  return {
    /* --- state --- */
    authed:false, me:null, error:'', globalError:'', formError:'', busy:false,
    login:{username:'',password:''},
    kpis:{revenue_cents:0,orders:0,customers:0,pageviews:0},
    orders:[], customers:[], leads:[], services:[], addons:[], addonFilter:'',
    modals:{ service:false, addon:false },

    /* forms */
    serviceForm:{
      id:'', _lockId:false,
      name:'', blurb:'',
      base_one_time_usd:0, base_monthly_usd:0,
      includes_list:[],
      includes_input:''
    },
    addonForm:{
      id:'', _lockId:false,
      service_id:'', label:'',
      description:'', short:'', badge:'',
      popular:false,
      price_one_time_usd:0, price_monthly_usd:0
    },

    /* derived */
    get filteredAddons(){ return this.addonFilter ? this.addons.filter(a=>a.service_id===this.addonFilter) : this.addons; },

    /* boot */
    async boot(){
      if (document.readyState === 'loading') {
        await new Promise(r => document.addEventListener('DOMContentLoaded', r, { once:true }));
      }
      await this.checkAuth();
      if (this.authed) { await this.refreshAll(); }
      initReorderWidget(); // independent widget
    },

    /* --- auth --- */
    async checkAuth(){
      try{
        const r = await API('me');
        if(!r.ok) throw 0;
        const j = await r.json();
        this.me = j.user; this.authed = true; this.globalError = '';
      }catch{ this.authed = false; }
    },
    async doLogin(){
      try{
        this.error=''; this.globalError='';
        const r = await API('login',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.login) });
        if(!r.ok){ this.error='Invalid login'; return; }
        this.authed = true; this.me = this.login.username; this.login={username:'',password:''};
        await this.refreshAll();
        if (window.orderWidget?.reload) window.orderWidget.reload();
      }catch(e){ this.error = e.message || 'Login failed'; }
    },
    async logout(){ await API('logout'); location.reload(); },

    /* --- data load --- */
    async refreshAll(){
      try{
        const [m,o,c,l,s,a] = await Promise.all([
          API('metrics').then(r=>r.ok?r.json():Promise.reject(r)),
          API('orders').then(r=>r.ok?r.json():Promise.reject(r)),
          API('customers').then(r=>r.ok?r.json():Promise.reject(r)),
          API('leads').then(r=>r.ok?r.json():Promise.reject(r)),
          API('services').then(r=>r.ok?r.json():Promise.reject(r)),
          API('addons').then(r=>r.ok?r.json():Promise.reject(r)),
        ]);
        this.kpis=m; this.orders=o; this.customers=c; this.leads=l; this.services=s; this.addons=a;
        this.globalError='';
      }catch(e){
        this.globalError = 'Failed to load dashboard data. Check /api/admin routes and credentials.';
      }
    },

    /* --- utils --- */
    fmtUSD(c){ return (Number(c||0)/100).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}); },
    slug(s){ return String(s||'').toLowerCase().trim().replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); },

    /* --- service CRUD --- */
    openService(s=null){
      this.formError='';
      if(s){
        this.serviceForm = {
          id:s.id, _lockId:true,
          name:s.name||'', blurb:s.blurb||'',
          base_one_time_usd: Math.round((s.base_one_time_cents||0)/100),
          base_monthly_usd: Math.round((s.base_monthly_cents||0)/100),
          includes_list: Array.isArray(s.includes) ? s.includes.slice() : [],
          includes_input:''
        };
      } else {
        this.serviceForm = {
          id:'', _lockId:false,
          name:'', blurb:'',
          base_one_time_usd:0, base_monthly_usd:0,
          includes_list:[], includes_input:''
        };
      }
      this.modals.service=true;
    },
    async saveService(){
      try{
        if(!this.canSaveService()){ this.formError='Please complete the required fields.'; return; }
        const f=this.serviceForm;
        const payload={
          id:f.id.trim(),
          name:f.name.trim(),
          blurb:f.blurb||'',
          base_one_time_cents: Math.round(Number(f.base_one_time_usd||0)*100),
          base_monthly_cents: Math.round(Number(f.base_monthly_usd||0)*100),
          includes: Array.isArray(f.includes_list) ? f.includes_list : []
        };
        const method = f._lockId ? 'PUT' : 'POST';
        const r = await API('services',{ method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error(e.error||'Save failed'); }
        this.modals.service=false; await this.refreshAll();
        if (window.orderWidget?.reload) window.orderWidget.reload();
      }catch(e){ this.formError=e.message || 'Save failed'; }
    },
    async delService(id){
      if(!confirm('Delete service '+id+'? This also deletes its add-ons.')) return;
      const r = await API('services', { method:'DELETE' }, { id });
      if(!r.ok){ alert('Delete failed'); return; }
      await this.refreshAll();
      if (window.orderWidget?.reload) window.orderWidget.reload();
    },

    addIncludeChip(){
      const v = (this.serviceForm.includes_input||'').trim();
      if(!v) return;
      this.serviceForm.includes_list.push(v);
      this.serviceForm.includes_input='';
    },
    removeIncludeChip(i){ this.serviceForm.includes_list.splice(i,1); },
    quickInclude(text){
      if(!this.serviceForm.includes_list.includes(text)){
        this.serviceForm.includes_list.push(text);
      }
    },
    maybeSuggestServiceKey(){
      if (this.serviceForm._lockId) return;
      if (!this.serviceForm.id) this.serviceForm.id = this.slug(this.serviceForm.name);
    },
    canSaveService(){
      return !!(this.serviceForm.id || !this.serviceForm._lockId) // new needs an id
        && !!this.serviceForm.name
        && this.serviceForm.base_one_time_usd >= 0
        && this.serviceForm.base_monthly_usd >= 0;
    },

    /* --- addon CRUD --- */
    openAddon(a=null){
      this.formError='';
      const firstService = this.services[0]?.id || '';
      if(a){
        this.addonForm = {
          id:a.id,_lockId:true,service_id:a.service_id,label:a.label||'',
          description:a.description||'', short:a.short||'', badge:a.badge||'',
          popular:!!a.popular,
          price_one_time_usd: Math.round((a.price_one_time_cents||0)/100),
          price_monthly_usd: Math.round((a.price_monthly_cents||0)/100)
        };
      } else {
        this.addonForm = {
          id:'',_lockId:false,service_id:firstService,label:'',
          description:'',short:'',badge:'',
          popular:false,price_one_time_usd:0,price_monthly_usd:0
        };
      }
      this.modals.addon=true;
    },
    async saveAddon(){
      try{
        if(!this.canSaveAddon()){ this.formError='Please complete the required fields.'; return; }
        const f=this.addonForm;
        const payload={
          id:f.id.trim(), service_id:f.service_id, label:f.label.trim(),
          description:f.description||'', short:f.short||'', badge:f.badge||'',
          popular: !!f.popular,
          price_one_time_cents: Math.round(Number(f.price_one_time_usd||0)*100),
          price_monthly_cents: Math.round(Number(f.price_monthly_usd||0)*100)
        };
        const r = await API('addons',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error(e.error||'Save failed'); }
        this.modals.addon=false; await this.refreshAll();
      }catch(e){ this.formError=e.message || 'Save failed'; }
    },
    async delAddon(id){
      if(!confirm('Delete add-on '+id+'?')) return;
      const r = await API('addons', { method:'DELETE' }, { id });
      if(!r.ok){ alert('Delete failed'); return; }
      await this.refreshAll();
    },
    maybeSuggestAddonId(){
      if (this.addonForm._lockId) return;
      const base = this.slug(this.addonForm.service_id || '');
      const label= this.slug(this.addonForm.label || '');
      if (base && label) this.addonForm.id = `${base}-${label}`;
    },
    canSaveAddon(){
      return !!this.addonForm.service_id
        && !!this.addonForm.label
        && (this.addonForm.price_one_time_usd >= 0)
        && (this.addonForm.price_monthly_usd >= 0)
        && (this.addonForm.id || !this.addonForm._lockId);
    },

    /* --- optional one-click seed (uses the public offerings) --- */
    siteCatalog:{
      services:[
        { key:'web', name:'Web & App', blurb:'Launch a clean, mobile-first site fast.', base:{oneTime:300, monthly:500}, includes:['Kickoff & setup','Landing page (3–5 sections)','Light copy help'] },
        { key:'video', name:'Video / Audio', blurb:'Short, on-brand edits that convert.', base:{oneTime:600, monthly:1200}, includes:['Kickoff & plan','1–2 min edit','Clean edit, coastal vibe'] },
        { key:'events', name:'Events', blurb:'Plan smooth, run tight, look great.', base:{oneTime:1000, monthly:1200}, includes:['Scope & timeline','Basic coordination','Day-of support'] },
        { key:'ugc', name:'UGC', blurb:'Creators + clips that actually get seen.', base:{oneTime:450, monthly:600}, includes:['Kickoff & setup','30k verified views','Simple report'] },
      ],
      addons:[
        ['web','web-seo','SEO Basics','Titles, speed checks, findable.','Quick search wins','Quick win',true,150,150],
        ['web','web-auto','Lead Automations','Instant replies to leads.','Never miss a lead','Hands-off',true,100,100],
        ['web','web-api','Payments & Maps','Stripe checkout + maps.','High-impact add','High impact',false,250,250],
        ['web','web-mvp','Clickable MVP','Tap-through prototype.','Test ideas','Prototype',false,500,500],
        ['web','web-copy','Website Copywriting','We write clear, on-brand copy.','Words that sell','Done-for-you',false,120,120],
        ['web','web-speed','Speed & Security','Performance boosts + hardening.','Faster & safer','Speed',false,150,150],
        ['web','web-forms','Smart Forms','Lead routing + spam block.','Higher conversions','Leads',false,150,100],
        ['web','web-analytics','Analytics Setup','Simple dashboard + goals.','Know what works','Insight',false,100,120],
        ['web','web-blog','Blog/CMS Setup','Easy updates, categories, tags.','Publish fast','Content',false,200,150],
        ['web','web-booking','Booking Integration','Calendly/Square appointments.','Fewer no-shows','Conversion',false,150,120],
        ['web','web-reviews','Reviews Widget','Pull Google/FB reviews on site.','Build trust','Trust',false,100,100],
        ['web','web-a11y','Accessibility Audit','WCAG quick audit + fixes.','Compliance wins','Compliance',false,180,150],
        ['web','web-i18n','Multi-language','Key pages in 2nd language.','Expand reach','Reach',false,220,150],
        ['web','web-dns','Domain & DNS','Purchase, connect, SSL.','We handle setup','Setup',false,80,0],
        ['web','web-section','Custom Section','1 bespoke section block.','Tailored UI','Custom',false,120,120],
        ['web','web-photos','Photo Sourcing','Handpicked stock + edits.','Better visuals','Visuals',false,90,90],
        ['web','web-brandkit','Brand Kit','Fonts, colors, components.','Consistent look','Brand',false,200,150],
      ]
    },
    async syncFromSite(){
      try{
        this.busy = true;
        for(const s of this.siteCatalog.services){
          const payload={ id:s.key, name:s.name, blurb:s.blurb||'', base_one_time_cents:Math.round((s.base?.oneTime||0)*100), base_monthly_cents:Math.round((s.base?.monthly||0)*100), includes:s.includes||[] };
          const r = await API('services',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
          if(!r.ok) throw new Error('Service upsert failed: '+s.key);
        }
        for(const a of this.siteCatalog.addons){
          const [service_id,id,label,description,short,badge,popular,oneTime,monthly]=a;
          const payload={ id,service_id,label,description,short,badge,popular:!!popular, price_one_time_cents:Math.round((oneTime||0)*100), price_monthly_cents:Math.round((monthly||0)*100) };
          const r = await API('addons',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
          if(!r.ok) throw new Error('Add-on upsert failed: '+id);
        }
        await this.refreshAll();
        if (window.orderWidget?.reload) window.orderWidget.reload();
      }catch(e){ this.globalError = e.message || 'Sync failed'; }
      finally{ this.busy=false; }
    },
  }
}
</script>

<script>
/* ------- Library-free reorder widget: drag & drop + arrows + keyboard ------- */
(function(){
  const listEl     = document.getElementById('orderList');
  const saveBtn    = document.getElementById('orderSave');
  const reloadBtn  = document.getElementById('orderReload');
  const msgEl      = document.getElementById('orderMsg');
  const saveFabBtn = document.getElementById('orderSaveFab');
  if (!listEl || !saveBtn || !reloadBtn) return;

  let services = [];           // working array in PUBLIC (homepage) shape
  let dragFromIndex = null;    // native DnD source index

  const esc = s => String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'","&#039;");

  function say(msg, ok=true){
    msgEl.textContent = msg;
    msgEl.style.color = ok ? '#64748b' : '#b91c1c';
  }

  function setDirty(d){
    saveBtn.disabled = !d;
    saveBtn.textContent = d ? 'Save Order' : 'Saved';
    if (saveFabBtn){
      saveFabBtn.classList.toggle('hidden', !d);
      saveFabBtn.textContent = d ? 'Save Order' : 'Saved';
      saveFabBtn.disabled = !d;
    }
  }

  function liTemplate(s){
    return `
      <div class="flex items-center gap-3 w-full">
        <div class="h-10 w-10 grid place-items-center rounded-lg bg-slate-100 ring-1 ring-slate-200 text-slate-600 cursor-grab select-none"
             aria-hidden="true">⋮⋮</div>

        <div class="flex-1 min-w-0">
          <div class="font-medium truncate">${esc(s.name||'Untitled')}</div>
          <div class="text-xs text-slate-500 truncate">${esc(s.blurb||'')}</div>
        </div>

        <div class="text-sm font-semibold text-slate-700 shrink-0 mr-1">
          $${(s.base?.oneTime ?? 0)}
        </div>

        <div class="flex gap-1 ml-2 shrink-0">
          <button type="button" class="btn-top rounded-md px-2 py-1 ring-1 ring-slate-200 text-xs"   title="Move to top">⤒</button>
          <button type="button" class="btn-up rounded-md px-2 py-1 ring-1 ring-slate-200 text-xs"    title="Move up">↑</button>
          <button type="button" class="btn-down rounded-md px-2 py-1 ring-1 ring-slate-200 text-xs"  title="Move down">↓</button>
          <button type="button" class="btn-bottom rounded-md px-2 py-1 ring-1 ring-slate-200 text-xs" title="Move to bottom">⤓</button>
        </div>
      </div>
    `;
  }

  function render(){
    listEl.innerHTML = '';
    services.forEach((s, idx) => {
      const li = document.createElement('li');
      li.className = 'group px-3 py-2 rounded-xl ring-1 ring-slate-200 bg-white hover:bg-slate-50';
      li.tabIndex = 0;          // keyboard focus
      li.draggable = true;      // native drag & drop
      li.dataset.key = s.key;
      li.dataset.index = String(idx);
      li.innerHTML = liTemplate(s);
      listEl.appendChild(li);

      // Per-row button handlers
      li.querySelector('.btn-up')?.addEventListener('click', () => moveIndex(idx, idx-1));
      li.querySelector('.btn-down')?.addEventListener('click', () => moveIndex(idx, idx+1));
      li.querySelector('.btn-top')?.addEventListener('click', () => moveIndex(idx, 0));
      li.querySelector('.btn-bottom')?.addEventListener('click', () => moveIndex(idx, services.length-1));

      // Keyboard move (on row)
      li.addEventListener('keydown', (e) => {
        if (['ArrowUp','ArrowDown','Home','End'].includes(e.key)) e.preventDefault();
        if (e.key === 'ArrowUp')   moveIndex(idx, Math.max(0, idx-1));
        if (e.key === 'ArrowDown') moveIndex(idx, Math.min(services.length-1, idx+1));
        if (e.key === 'Home')      moveIndex(idx, 0);
        if (e.key === 'End')       moveIndex(idx, services.length-1);
      });

      // Native drag & drop
      li.addEventListener('dragstart', (e) => {
        dragFromIndex = idx;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', String(idx));
        li.classList.add('opacity-60');
      });
      li.addEventListener('dragend', () => {
        li.classList.remove('opacity-60');
        dragFromIndex = null;
      });
      li.addEventListener('dragover', (e) => {
        e.preventDefault();      // allow drop
        e.dataTransfer.dropEffect = 'move';
        li.classList.add('ring-2','ring-indigo-300');
      });
      li.addEventListener('dragleave', () => {
        li.classList.remove('ring-2','ring-indigo-300');
      });
      li.addEventListener('drop', (e) => {
        e.preventDefault();
        li.classList.remove('ring-2','ring-indigo-300');
        const from = dragFromIndex ?? Number(e.dataTransfer.getData('text/plain'));
        const to   = Number(li.dataset.index);
        if (!Number.isInteger(from) || !Number.isInteger(to)) return;
        moveIndex(from, to);
      });
    });
  }

  function moveIndex(i, j){
    if (i === j || i < 0 || j < 0 || i >= services.length || j >= services.length) return;
    const [item] = services.splice(i, 1);
    services.splice(j, 0, item);
    render();
    setDirty(true);
    // keep target in view and focused
    const target = listEl.children[j];
    if (target){ target.scrollIntoView({ block:'nearest' }); target.focus({ preventScroll:true }); }
  }

  async function loadCatalog(){
    try{
      say('Loading…');
      const r = await fetch('/api/admin?r=catalog', { credentials:'include', cache:'no-store' });
      if(!r.ok){
        if (r.status === 401) say('Please login to reorder.', false);
        else say('Failed to load catalog ('+r.status+').', false);
        return;
      }
      const j = await r.json();
      services = Array.isArray(j.services) ? j.services.slice() : [];
      render();
      setDirty(false);
      say(services.length ? 'Reorder, then save.' : 'No services in catalog.');
    }catch(e){
      console.error(e);
      say('Catalog error: '+(e.message||e), false);
    }
  }

  async function saveOrder(){
    try{
      saveBtn.disabled = true; saveBtn.textContent = 'Saving…';
      if (saveFabBtn){ saveFabBtn.disabled = true; saveFabBtn.textContent = 'Saving…'; }

      const payload = {
        services: services.map(s => ({
          key:s.key, name:s.name, blurb:s.blurb, base:s.base,
          includes:Array.isArray(s.includes)?s.includes:[],
          addOns:Array.isArray(s.addOns)?s.addOns:[]
        }))
      };
      const r = await fetch('/api/admin?r=save-catalog', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body:JSON.stringify(payload)
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || 'Save failed');
      setDirty(false);
      say('Order saved. Homepage will reflect the new order.');
    }catch(e){
      console.error(e);
      say('Save failed: '+(e.message||e), false);
      setDirty(true);
    }finally{
      saveBtn.textContent = saveBtn.disabled ? 'Saved' : 'Save Order';
      if (saveFabBtn){ saveFabBtn.disabled = false; saveFabBtn.textContent = 'Save Order'; }
    }
  }

  // Wire up controls
  reloadBtn.addEventListener('click', loadCatalog);
  saveBtn.addEventListener('click', saveOrder);
  if (saveFabBtn) saveFabBtn.addEventListener('click', saveOrder);

  // Expose reload so Alpine can call it after login/CRUD
  window.orderWidget = { reload: loadCatalog };

  // Load on first paint
  window.addEventListener('load', loadCatalog);
})();
</script>
</body>
</html>
